<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <!-- prevent favicon request -->
    <link href="data:;base64,iVBORw0KGgo=" rel="icon" />
    <title>React Twitch Active Users</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
      crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <div id="root"></div>
    <!--
         Uncomment if you need this
         <script
         src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
         integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
         crossorigin="anonymous"></script>
         <script
         src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
         integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
         crossorigin="anonymous"></script>
         <script
         src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
         integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
         crossorigin="anonymous"></script>
    -->

    <!-- babel is required in order to parse JSX  IMPORTANT-->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!--
         Load React.
         Note: when deploying, replace "development.js" with "production.min.js".
    -->
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin></script>

    <!--
         Load React-Bootstrap
    -->
    <script
      src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js"
      crossorigin></script>

    <!--
         Load our React component.
         IMPORTANT

         Without the type="text/babel" this doesn't work.

         Something like this  will work:
         <script type="text/babel" src="./js/script.js"></script>

         But, you will get a validation(html) error:
         A "script" element with a "src" attribute must not have a
         "type" attributewhose value is anything other than the empty string,
         a JavaScript MIME type, or "module".
    -->

    <script type="text/babel">
      var {useEffect, useState} = React;

      var Container   = ReactBootstrap.Container;
      var Row         = ReactBootstrap.Row;
      var Col         = ReactBootstrap.Col;


      const placeholder = "img/placeholder.png";

      const USERS = [
      "ESL_SC2",
      "OgamingSC2",
      "cretetion",
      "freecodecamp",
      "storbeck",
      "habathcx",
      "RobotCaleb",
      "noobs2ninjas"];

      const PATH_BASE  = 'https://wind-bow.glitch.me/twitch-api';
      const PARAM_USER = '/users/';
      const PARAM_STREAM =  '/streams/';
      const USER_URL_ARR = USERS.map(ele => `${PATH_BASE}${PARAM_USER}${ele}`);
      const STREAM_URL_ARR = USERS.map(ele => `${PATH_BASE}${PARAM_STREAM}${ele}`);

      const Menu =  ( { isLoading, onClick } ) => ( isLoading )
      ? <div>
         <Menu />
         <div className="message">
           <h1>Loading&nbsp;...</h1>
         </div>
        </div>

      : <div className="menu" >
         <button onClick={ onClick } >All</button>
         <button onClick={ onClick } >Online</button>
         <button onClick={ onClick } >Offline</button>
       </div>;


      const Table = ( { isLoading, children } ) =>
      ( !isLoading )
      ? <table className="table">
         { children }
        </table>
      : null;

      function Tr ( { onClick, selected, list, status} ) {

         const idUsersOnline = status
                                   .filter( el => el.stream != null)
                                   .map( el =>   el.stream.channel._id );
         
         const usersOffline  = list
                                   .filter( el => !idUsersOnline.includes( el._id ) )
                                   .map( ele => Object.assign( {},
                                           ({
                                               name: ele.display_name,
                                               logo: ele.logo || placeholder,
                                               id: ele._id,
                                               status: 'offline',
                                               game: ''
                                    })));


         const usersOnline = status
                                  .filter( el => el.stream != null )
                                  .map( ele =>
                                         Object.assign( {},
                                         ({
                                         name: ele.stream.channel.display_name,
                                         logo: ele.stream.channel.logo || placeholder,
                                         id: ele.stream.channel._id,
                                         status: 'online',
                                         game: ele.stream.game
                                   })));

         const userDataAndStatusArr =   usersOnline.concat( usersOffline );

         var userInfo = userDataAndStatusArr.map(  el  =>
         <tr
           key={  el.id }
           className={
               `table__tr  table__tr--${ el.status } ${
               (
               selected === 'All' ||
               selected === 'Online' && el.status  === 'online' ||
               selected === 'Offline' && el.status  === 'offline'
               )
               ? ''
               : 'hidden'
               }`
               }
         >
           <td
             key={
                 `${ el.name }-logo`}
             className="table__td" >
             <img
               key={ `${ el.name }-img` }
               alt=""
               src={ el.logo }
               className="table__td__img"
             />
           </td>
           <td
             key={ el.name }
             className="table__td"
           >
             { el.name }
           </td>
           <td
             key={ `${ el.name }-status` }
             className="table__td"
           >
             { el.status }
           </td>
           <td
             key={ el.game }
             className="table__td"
           >
             { el.game }
           </td>
        </tr>);

         return <tbody>
           <tr className="table__th">
             <th>logo</th>
             <th>name</th>
             <th>status</th>
             <th>game</th>
           </tr>
           {  userInfo }
         </tbody>;
      };


      function App () {
         const [isLoading, setLoading]  = useState(true);
         const [selected,  setSelected] = useState("All");
         const [result,    setResult]   = useState([]);
         const [stream,    setStream]   = useState([]);

     
         useEffect( () => {
         /*
         Not sure about this one, maybe is better to use only Promise.all
         (without the  fetch* async functions)
         */

         const fetchUsers = async ()  => {
            let users = USER_URL_ARR.map(
            url => fetch( url )
            .then( res => res.json() )
            .then( json => json ));

            Promise.all(users).then(val => setResult(val));

         };

         const fetchStream = async() => {
            let usersStream =  STREAM_URL_ARR.map(
            url => fetch( url )
            .then( res => res.json())
            .then( json => json));

            Promise.all(usersStream).then(val => setStream(val));
         };

         fetchUsers();
         fetchStream();
         setLoading(false);
     },[]);

      return (
      <div className="content" >
        <Menu
           onClick={(event) => setSelected(event.target.textContent) }
           isLoading={ isLoading  } />
        <Table isLoading={ isLoading } >
          <Tr
            selected={selected}
            list={result}
            status={stream}
          />
        </Table>
      </div>
      );
      }


      ReactDOM.render(
        <App />,
        document.getElementById('root')
      );
    </script>

  </body>
</html>
